/*! kendo-loopback-ds - 2016-01-19
* http://akera.io
* Author: Radu Nicoara
* Copyright (c) 2016 Acorn IT;
* SEE LICENSE IN <LICENSE> */
function convertToKendo(a){var b={name:a.name,fields:{}};for(var c in a.properties){var d=a.properties[c];b.fields[c]={nullable:!d.required||!1,editable:!(d.id&&d.id===!0)},d.id===!0&&(b.id=c,delete b.fields[c].id),delete b.fields[c].required}return b}if(kendo.loopback=kendo.loopback||{},kendo.loopback.DataSource=kendo.data.DataSource.extend({init:function(a){if(!a.lbModel)throw new Error("Invalid loopback model specified");var b=new kendo.loopback.Transport(a.lbModel);b.dataSource=this,a.transport=b,a.serverFiltering=void 0===a.serverFiltering?!0:a.serverFiltering,a.serverPaging=void 0===a.serverPaging?!0:a.serverPaging,a.serverSorting=void 0===a.serverSorting?!0:a.serverSorting,a.schema=a.schema||{},a.schema.model=convertToKendo(a.lbModel.schema),a.schema.total=a.schema.total||"count",kendo.data.DataSource.fn.init.call(this,a)}}),kendo.loopback=kendo.loopback||{},kendo.loopback.Filter={getClause:function(a){var b={};switch(a.operator){case"eq":b[a.field]=a.value;break;case"neq":b[a.field]={neq:a.value};break;case"gte":b[a.field]={gte:a.value};break;case"lte":b[a.field]={lte:a.value};break;case"lt":b[a.field]={lt:a.value};break;case"gt":b[a.field]={gt:a.value};break;case"contains":b[a.field]={like:"*"+a.value+"*"};break;case"startswith":b[a.field]={like:a.value+"*"};break;case"endswith":b[a.field]={like:"*"+a.value};break;default:throw new TypeError("Filter operator "+a.operator+" is not supported.")}return b},recursiveFilter:function(a){var b=this,c={};return a.filters?(c[a.logic]=[],a.filters.forEach(function(d){c[a.logic].push(b.recursiveFilter(d))}),c):this.getClause(a)},convert:function(a,b){var c=this.recursiveFilter(a);return b===!0?c:{where:c}}},!jQuery)throw new Error("kendo.loopback requires jQuery!");kendo.loopback=kendo.loopback||{};var LoopbackTransport=function(a){if(!a)throw new Error("Invalid loopback model specified");this.lbModel=a};LoopbackTransport.prototype={read:function(a){var b=this.lbModel,c={},d=this;c.limit=a.data.pageSize||null,this.dataSource.options.serverPaging===!0&&a.data.page&&a.data.page>1&&(c.offset=a.data.skip+1),this.dataSource.options.serverSorting===!0&&a.data.sort&&(c.order=[],a.data.sort.forEach(function(a){c.order.push(a.field+" "+a.dir.toUpperCase())})),this.dataSource.options.serverFiltering===!0&&a.data.filter&&jQuery.extend(!0,c,kendo.loopback.Filter.convert(a.data.filter,!1)),b.find({filter:c}).$promise.then(function(e){d.dataSource.options.serverPaging===!0?b.count({where:c.where}).$promise.then(function(b){e[d.dataSource.options.schema.total]=b.count,a.success(e)}):a.success(e)})},create:function(a){var b=this.lbModel,c=this.dataSource.options.schema.model.id,d=a.data,e={};for(var f in d)f!==c&&(e[f]=d[f]);b.create(e).$promise.then(function(b){b.$promise=null,a.success(b)},function(b){a.error(b)})},update:function(a){var b={},c=this.dataSource.options.schema.model.id;b[c]=a.data[c],this.lbModel.prototype$updateAttributes(b,a.data).$promise.then(function(b){var c={};c.prototype={},jQuery.extend(!0,c.prototype,b.prototype);for(var d in b)"$promise"!==d&&"_events"!==d&&"$resolved"!==d&&"dirty"!==d&&(c[d]=b[d]);a.success(c)},function(b){a.error(b)})},"delete":function(a){var b={},c=this.dataSource.options.schema.model.id;b[c]=a.data[c],this.lbModel.deleteById(b).$promise.then(function(b){a.success(b)},function(b){a.error(b)})}},kendo.loopback.Transport=LoopbackTransport;